#!/bin/bash
# Small script to control container behavior.

function show_help {
  printf "Used to launch CVE database.\n \
          \t-h|--help: this help menu\n\
          \t-i|--initialize: initialize database for the first time\n\
          \t-u|--update: update database\n\
          \t-r|--repopulate: repopulate database\n"
}

function update_repo {
  git pull
  pip3 install -r requirements.txt
}

function start_mongodb {
  if ! pidof -x "mongod" >/dev/null; then
    mongod &
  fi
}

function start_redis {
  if ! pidof -x "redis-server" >/dev/null; then
    redis-server &
  fi
}

function restart_mongodb {
  if pidof -x "mongod" >/dev/null; then
    kill $(pidof -x "mongod")
    sleep 5
    mongod &
  fi
}

function restart_redis {
  if pidof -x "redis-server" >/dev/null; then
    kill $(pidof -x "redis-server")
    sleep 5
    redis-server &
  fi
}
function populate_database {
  ./sbin/db_mgmt_cpe_dictionary.py -p
  ./sbin/db_mgmt_json.py -p
  ./sbin/db_updater.py -c
  ./sbin/db_mgmt_ref.py
}

function update_database {
  ./sbin/db_updater.py -v
}

function repopulate_database {
  ./sbin/db_updater.py -v -f
}

# Validate number of arguments
if [ $# -eq 0 ]
  then
    show_help
    exit 0
fi

# Parse arguments
while [[ $# -gt 0 ]]
do
  key="$1"
  case $key in
      -h|--help)
      show_help
      ;;
      -i|--initialize)
      update_repo
      start_mongodb
      start_redis
      populate_database
      restart_mongodb
      ;;
      -u|--update)
      update_repo
      start_mongodb
      start_redis
      update_database
      ;;
      -r|--repopulate)
      update_repo
      start_mongodb
      start_redis
      repopulate_database
      ;;
      *)
      show_help
      ;;
  esac
  shift
done

# Done!
exit 0